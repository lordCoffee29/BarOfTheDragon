// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model units {
  name        String  @id
  type        String
  base_unit   String
  multiplier  Float

  ingredient  ingredient[]
  ingredient_item ingredient_item[]
  drink_recipe drink_recipe[]
}

model receipt {
  id          Int      @id @default(autoincrement())
  date        DateTime @default(now())
  created_at  DateTime @default(now())

  transactions transactions[]
  @@unique([id, date])
}

model purchase_category {
  name   String @id
  transactions transactions[]
}

model transactions {
  id          Int      @id @default(autoincrement())
  receipt_id  Int
  line_num    Int
  item        String
  brand       String?
  category    String
  date        DateTime
  price       Float
  note        String?
  created_at  DateTime @default(now())
  updated_at  DateTime? 
  quantity    Int
  pack_size   Int?

  // TO-DO: trans date refs receipt date
  purchase_category  purchase_category @relation(fields: [category], references: [name])
  receipt           receipt @relation(fields: [receipt_id, date], references: [id, date])
  liquor_bottle     liquor_bottle[]
  base_bottle       base_bottle[]
  ingredient_item   ingredient_item[]
  tool              tool[]

  @@unique([receipt_id, line_num])
}

model liquor_type {
  name   String  @id
  liquor liquor[]
}

model liquor {
  liquor_id Int    @id @default(autoincrement())
  brand     String?
  name      String
  mL        Int
  ABV       Int
  img_path  String
  type      String
  present   Boolean
  price     Float

  liquor_type liquor_type @relation(fields: [type], references: [name])
  liquor_bottle liquor_bottle[]

  @@unique([brand, name, mL])
}

model liquor_bottle {
  id             Int       @id @default(autoincrement())
  liquor_id      Int
  transaction_id Int
  date_opened    DateTime?
  date_finished  DateTime?
  quantity       Int       @default(100)

  liquor      liquor      @relation(fields: [liquor_id], references: [liquor_id])
  transactions transactions @relation(fields: [transaction_id], references: [id])
}

model base_type {
  name String @id
  base base[]
}

model base {
  id       Int     @id @default(autoincrement())
  brand    String?
  name     String
  mL       Int
  img_path String
  type     String
  present  Boolean
  price    Float

  base_type base_type @relation(fields: [type], references: [name])
  base_bottle base_bottle[]

  @@unique([brand, name, mL])
}

model base_bottle {
  id             Int       @id @default(autoincrement())
  base_id        Int
  transaction_id Int
  date_opened    DateTime?
  date_finished  DateTime?
  quantity       Int       @default(100)

  base        base        @relation(fields: [base_id], references: [id])
  transactions transactions @relation(fields: [transaction_id], references: [id])
}

model ingredient_type {
  name        String       @id
  ingredient  ingredient[]
}

model ingredient {
  id        Int     @id @default(autoincrement())
  name      String             
  quantity  Float               
  unit      String                        
  brand     String?
  type      String   
  img_path  String
  present   Boolean
  price     Float

  ingredient_type ingredient_type @relation(fields: [type], references: [name])
  units            units            @relation(fields: [unit], references: [name])
  ingredient_item ingredient_item[]

  @@unique([name, quantity, unit])
}

model ingredient_item {
  id             Int       @id @default(autoincrement())
  brand          String?
  name           String
  quantity       Float
  unit           String
  transaction_id Int
  date_opened    DateTime?
  date_finished  DateTime?

  ingredient  ingredient  @relation(fields: [name, quantity, unit], references: [name, quantity, unit])
  units        units        @relation(fields: [unit], references: [name])
  transactions transactions @relation(fields: [transaction_id], references: [id])
}

model tool_type {
  name String @id
  tool tool[]
}

model tool { 
  name     String @id
  transaction_id Int
  quantity Int
  unit     String
  type     String
  price    Float


  tool_type tool_type @relation(fields: [type], references: [name])
  transactions transactions @relation(fields: [transaction_id], references: [id])
}

model drink {
  name     String         @id
  img_path String

  drink_recipe  drink_recipe[]
  drink_variant drink_variant[]
}

model drink_recipe {
  id         Int    @id @default(autoincrement())
  name       String
  ingredient String
  quantity   Int
  unit       String

  drink drink @relation(fields: [name], references: [name])
  units  units  @relation(fields: [unit], references: [name])

  drink_variant drink_variant[]

  @@unique([name, ingredient])
}

model drink_variant {
  id                Int   @id @default(autoincrement())
  drink_id          Int
  base_drink        String
  variant_name      String
  img_overlay_path  String?
  notes             String?

  drink    drink    @relation(fields: [base_drink], references: [name])
  drink_recipe  drink_recipe  @relation(fields: [drink_id], references: [id])
  drink_variant_ingredients drink_variant_ingredient[]

  @@unique([base_drink, variant_name])
}

model drink_variant_ingredient {
  variant_id             Int
  original_ingredient    String
  replacement_ingredient String

  drink_variant drink_variant @relation(fields: [variant_id], references: [id])
  // UI needs to enforce that original_ingredient is present, maybe a button interface for ingredients?

  @@id([variant_id, original_ingredient])
}